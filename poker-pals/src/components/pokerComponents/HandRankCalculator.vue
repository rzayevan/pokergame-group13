<template>
    <div class="box">
        <button v-on:click="toggleImage('1_1')" class="card" id="1_1">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('1_2')" class="card" id="1_2">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('1_3')" class="card" id="1_3">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('1_4')" class="card" id="1_4">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('1_5')" class="card" id="1_5">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('1_6')" class="card" id="1_6">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('1_7')" class="card" id="1_7">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('1_8')" class="card" id="1_8">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('1_9')" class="card" id="1_9">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('1_10')" class="card" id="1_10">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('1_11')" class="card" id="1_11">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('1_12')" class="card" id="1_12">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('1_13')" class="card" id="1_13">
            <img src="../images/cards.png"/>
        </button>

        <button v-on:click="toggleImage('2_1')" class="card" id="2_1">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('2_2')" class="card" id="2_2">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('2_3')" class="card" id="2_3">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('2_4')" class="card" id="2_4">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('2_5')" class="card" id="2_5">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('2_6')" class="card" id="2_6">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('2_7')" class="card" id="2_7">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('2_8')" class="card" id="2_8">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('2_9')" class="card" id="2_9">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('2_10')" class="card" id="2_10">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('2_11')" class="card" id="2_11">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('2_12')" class="card" id="2_12">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('2_13')" class="card" id="2_13">
            <img src="../images/cards.png"/>
        </button>
        
        <button v-on:click="toggleImage('3_1')" class="card" id="3_1">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('3_2')" class="card" id="3_2">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('3_3')" class="card" id="3_3">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('3_4')" class="card" id="3_4">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('3_5')" class="card" id="3_5">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('3_6')" class="card" id="3_6">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('3_7')" class="card" id="3_7">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('3_8')" class="card" id="3_8">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('3_9')" class="card" id="3_9">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('3_10')" class="card" id="3_10">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('3_11')" class="card" id="3_11">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('3_12')" class="card" id="3_12">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('3_13')" class="card" id="3_13">
            <img src="../images/cards.png"/>
        </button>

        <button v-on:click="toggleImage('4_1')" class="card" id="4_1">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('4_2')" class="card" id="4_2">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('4_3')" class="card" id="4_3">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('4_4')" class="card" id="4_4">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('4_5')" class="card" id="4_5">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('4_6')" class="card" id="4_6">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('4_7')" class="card" id="4_7">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('4_8')" class="card" id="4_8">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('4_9')" class="card" id="4_9">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('4_10')" class="card" id="4_10">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('4_11')" class="card" id="4_11">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('4_12')" class="card" id="4_12">
            <img src="../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('4_13')" class="card" id="4_13">
            <img src="../images/cards.png"/>
        </button>

        <button v-on:click="calculate()">get number</button>
        <p id="result">0</p>
        <p id="resultChars">0</p>
    </div>
</template>

<style scoped>

    .card {
        float: left;
        width: 71px;
        height: 96px;
        overflow: hidden;
        opacity: 0.3;
    }

   .card img {
        width: 923px;
        height: 384px;
    }

    .box{
        width: 923px;
        margin: auto;
    }

</style>

<script>
import Card from './Card';

export default {
    name: "HandRankCalculator",
    mounted(){
        for(let i = 1; i <= 4; i++){
            for(let j = 1; j <= 13; j++){
                let a = -1 - (96 * (i-1));
                let b = -9 - (71 * (j-1));
                let div = document.getElementById(i.toString() + '_' + j.toString());
                div.getElementsByTagName('img')[0].style.margin = a.toString() + "px 0px 0px " + b.toString() + "px";
                //document.getElementById("myDiv").style.margin = "50px 10px 20px 30px"; 
            }
        }
    },
    methods:{
        toggleImage(id){
            let cardImage = document.getElementById(id);
            //console.log(JSON.cardImage);
            if(cardImage.style.opacity < 1.0){
                cardImage.style.opacity = 1.0;
            }
            else{
                cardImage.style.opacity = 0.3;
            }
        },
        calculate(){
            let cards = new Array(7);
            let k = 0;
            for(let i = 1; i <= 4; i++){
                for(let j = 1; j <= 13; j++){
                    let div = document.getElementById(i.toString() + '_' + j.toString());
                    if(div.style.opacity > 0.3){
                        // found a selected card
                        cards[k] = new Card(j, Card.getSuit(i));
                        k++;
                        if(k >= 7){
                            // break the loops
                            i = 5;
                            j = 14;
                        }
                    }
                }
            }
            if(k < 7){
                console.log('not enough cards');
                return;
            }

            let result = -1;
            
            result = this.handStraightFlushValue(cards);
            if(result != -1){
                document.getElementById('result').innerHTML = result.toString(16);
                document.getElementById('resultChars').innerHTML = this.convertToChars(result.toString(16));
                return;
            }
            result = this.handQuadsValue(cards);
            if(result != -1){
                document.getElementById('result').innerHTML = result.toString(16);
                document.getElementById('resultChars').innerHTML = this.convertToChars(result.toString(16));
                return;
            }
            result = this.handFullHouseValue(cards);
            if(result != -1){
                document.getElementById('result').innerHTML = result.toString(16);
                document.getElementById('resultChars').innerHTML = this.convertToChars(result.toString(16));
                return;
            }
            result = this.handFlushValue(cards, false);
            if(result != -1){
                document.getElementById('result').innerHTML = result.toString(16);
                document.getElementById('resultChars').innerHTML = this.convertToChars(result.toString(16));
                return;
            }
            result = this.handStraightValue(cards, true);
            if(result != -1){
                document.getElementById('result').innerHTML = result.toString(16);
                document.getElementById('resultChars').innerHTML = this.convertToChars(result.toString(16));
                return;
            }
            result = this.handThreeOfAKindValue(cards, 2);
            if(result != -1){
                document.getElementById('result').innerHTML = result.toString(16);
                document.getElementById('resultChars').innerHTML = this.convertToChars(result.toString(16));
                return;
            }
            result = this.handTwoPairValue(cards, 1);
            if(result != -1){
                document.getElementById('result').innerHTML = result.toString(16);
                document.getElementById('resultChars').innerHTML = this.convertToChars(result.toString(16));
                return;
            }
            result = this.handSinglePairValue(cards, 3);
            if(result != -1){
                document.getElementById('result').innerHTML = result.toString(16);
                document.getElementById('resultChars').innerHTML = this.convertToChars(result.toString(16));
                return;
            }
            result = this.handHighCardValue(cards, 5, true);
            if(result != -1){
                document.getElementById('result').innerHTML = result.toString(16);
                document.getElementById('resultChars').innerHTML = this.convertToChars(result.toString(16));
                return;
            }
        },
        handStraightFlushValue(cards){
            let numbers = this.handFlushValue(cards, true);
            if(numbers === -1){
                return -1;
            }
            let a = this.getRemainingCards(numbers);
            let straightResult = this.handStraightValue(a, false);
            if(straightResult === -1){
                return -1;
            }
            let result = 0x900000 + straightResult;
            return result;
        },
        handQuadsValue(cards){
            let numbers = this.getTheNumbersArrayA14(cards);
            numbers.sort(function(a, b){return a - b});
            let twoToAceCount = this.getTwoToAceCount(numbers);
            let cardNumber = this.findHighestGroup(twoToAceCount, 4);
            if(cardNumber === -1){
                return -1;
            }
            let quadResult = 0;
            for(let k = 4; k > 0; k--){
                quadResult += cardNumber * this.integerPow(16, k);
            }
            this.removeSomeMatchingKeys(numbers, cardNumber, 4);
            let remainingCards = this.getRemainingCards(numbers);
            let highCardResult = this.handHighCardValue(remainingCards, 1, false);
            let result = 0x800000 + quadResult + highCardResult;
            return result;
        },
        handFullHouseValue(cards){
            let threeOfAKindValueResult = this.handThreeOfAKindValue(cards, 0);
            if(threeOfAKindValueResult === -1){
                return -1;
            }
            let tripletResult = threeOfAKindValueResult.tripletResult;
            let remainingCards = threeOfAKindValueResult.remainingCards;
            let singlePairResult = this.handSinglePairValue(remainingCards, 0);
            if(singlePairResult === -1){
                return -1;
            }
            let result = 0x700000 + tripletResult * this.integerPow(16, 2) + singlePairResult;
            return result;
        },
        handFlushValue(cards, returnNumbers){
            let suits = [];
            suits.push([]); suits.push([]); suits.push([]); suits.push([]);
            for(let i = 0; i < cards.length; i++){
                let number = cards[i].number;
                if(number === 1){
                    number = 14;
                }
                suits[Card.getSuitNumber(cards[i].suit) - 1].push(number);
            }
            let result = 0x600000;
            for(let i = 0; i < 4; i++){
                if(suits[i].length >= 5){
                    suits[i].sort(function(a, b){return a - b});
                    if(returnNumbers){
                        return suits[i];
                    }
                    for(let k = 0; k < 5; k++){
                        result += suits[i][(suits[i].length - 1) - k] * this.integerPow(16, 4-k);
                    }
                    return result;
                }
            }
            return -1;
        },
        handStraightValueImproved(cards, returnRank){
            let result = -1;
            let numbers = this.getTheNumbersArrayA14(cards);
            numbers.sort(function(a, b){return a - b});
            numbers = this.removeDuplicates(numbers);
            // we start from the end and work our way down and include a special case for the ace also equal to 1
            let count = 1; // we will always have a straight of atleast 1
            for(let i = numbers.length - 1; i >= 4; i--){
                // then we go further down
                for(let j = i - 1; j >= 0; j--){
                    if(numbers[j] === numbers[i] - count){
                        count++;
                        if(count === 5){
                            // we have a straight
                            if(returnRank){
                                result = 0x500000;
                            }
                            for(let k = 0; k < 5; k++){
                                result += numbers[i-k] * this.integerPow(16, 4-k);
                            }
                            i = -1;
                            j = -1;
                        }
                    }
                    else{
                        // the run ended, set i to position j
                        count = 1;
                        i = j;
                    }
                }
            }
            if(result === -1){
                numbers = this.getTheNumbersArray(cards);
                numbers.sort(function(a, b){return a - b});
                numbers = this.removeDuplicates(numbers);
                // we start from the end and work our way down and include a special case for the ace also equal to 1
                count = 1; // we will always have a straight of atleast 1
                for(let i = numbers.length - 1; i >= 4; i--){
                    // then we go further down
                    for(let j = i - 1; j >= 0; j--){
                        if(numbers[j] === numbers[i] - count){
                            count++;
                            if(count === 5){
                                // we have a straight
                                if(returnRank){
                                    result = 0x500000;
                                }
                                for(let k = 0; k < 5; k++){
                                    result += numbers[i-k] * this.integerPow(16, 4-k);
                                }
                                i = -1;
                                j = -1;
                            }
                        }
                        else{
                            // the run ended, set i to position j
                            count = 1;
                            i = j;
                        }
                    }
                }
            }
            return result;
        },
        handStraightValue(cards, returnRank){
            // run this twice with ace = 1 and ace = 14
            let result = -1;
            let numbers = this.getTheNumbersArrayA14(cards);
            numbers.sort(function(a, b){return a - b});
            numbers = this.removeDuplicates(numbers);
            // we start from the end and work our way down and include a special case for the ace also equal to 1
            console.log(JSON.stringify(numbers));
            let count = 1; // we will always have a straight of atleast 1
            for(let i = numbers.length - 1; i >= 4; i--){
                // then we go further down
                for(let j = i - 1; j >= 0; j--){
                    console.log('i:' + i + ' j:' + j + ' count:' + count + ' ' + numbers[j] + ' ' + numbers[i]);
                    if(numbers[j] === numbers[i] - count){
                        count++;
                        if(count === 5){
                            result = 0x000000;
                            // we have a straight
                            console.log('straight');
                            if(returnRank){
                                result = 0x500000;
                            }
                            for(let k = 0; k < 5; k++){
                                console.log('intspow: ' + (numbers[i-k] * this.integerPow(16, 4-k)).toString(16));
                                console.log('result1: ' + result.toString(16));
                                result += numbers[i-k] * this.integerPow(16, 4-k);
                                console.log('result2: ' + result.toString(16));
                            }
                            console.log(result.toString(16));
                            return result;
                        }
                        else if(count === 4 && numbers[i] === 5 && numbers[numbers.length - 1] === 14){
                            // we have count of four going 2,3,4,5 and an ace, its a straight
                            result = 0x000001;
                            if(returnRank){
                                result = 0x500001;
                            }
                            for(let k = 0; k < 4; k++){
                                result += numbers[i-k] * this.integerPow(16, 4-k);
                            }
                            return result;
                        }
                    }
                    else{
                        // the run ended, set i to position j
                        count = 1;
                        i = j;
                    }
                }
            }
            return result;
        },
        handThreeOfAKindValue(cards, highCardSendBack){
            let numbers = this.getTheNumbersArrayA14(cards);
            numbers.sort(function(a, b){return a - b});
            let twoToAceCount = this.getTwoToAceCount(numbers);
            let cardNumber = this.findHighestGroup(twoToAceCount, 3);
            if(cardNumber === -1){
                return -1;
            }
            let tripletResult = 0;
            for(let k = 2; k >= 0; k--){
                tripletResult += cardNumber * this.integerPow(16, highCardSendBack + k);
            }
            this.removeSomeMatchingKeys(numbers, cardNumber, 3);
            let remainingCards = this.getRemainingCards(numbers);
            
            if(highCardSendBack === 0){
                return {tripletResult: tripletResult, remainingCards: remainingCards};
            }

            let highCardsResult = this.handHighCardValue(remainingCards, highCardSendBack, false);
            if(highCardsResult === -1){
                return -1; // error
            }
            let result = 0x400000 + tripletResult + highCardsResult;
            return result;
        },
        handTwoPairValue(cards, highCardSendBack){
            let numbers = this.getTheNumbersArrayA14(cards);
            numbers.sort(function(a, b){return a - b});
            let twoToAceCount = this.getTwoToAceCount(numbers);
            let cardNumber = this.findHighestGroup(twoToAceCount, 2);
            if(cardNumber === -1){
                return -1;
            }
            let firstPairResult = cardNumber * this.integerPow(16, highCardSendBack + 3) + cardNumber * this.integerPow(16, highCardSendBack + 2);
            this.removeSomeMatchingKeys(numbers, cardNumber, 2);
            let remainingCards = this.getRemainingCards(numbers);
            let secondPairResult = this.handSinglePairValue(remainingCards, highCardSendBack);
            if(secondPairResult === -1){
                return -1;
            }
            let result = 0x300000 + firstPairResult + (secondPairResult - 0x200000); // remove the single pair status
            return result;
        },
        handSinglePairValue(cards, highCardSendBack){
            let numbers = this.getTheNumbersArrayA14(cards);
            numbers.sort(function(a, b){return a - b}); // now the array is sort low to high
            let twoToAceCount = this.getTwoToAceCount(numbers);
            let cardNumber = this.findHighestGroup(twoToAceCount, 2);
            if(cardNumber === -1){
                return -1;
            }
            let pairResult = cardNumber * this.integerPow(16, highCardSendBack + 1) + cardNumber * this.integerPow(16, highCardSendBack);
            if(highCardSendBack === 0){
                return pairResult;
            }
            this.removeSomeMatchingKeys(numbers, cardNumber, 2);
            let remainingCards = this.getRemainingCards(numbers);
            let highCardResult = this.handHighCardValue(remainingCards, highCardSendBack, false); // if full house is calling this then highCardSendBack = 0, and 0 is returned
            let result = 0x200000 + pairResult + highCardResult;
            return result;
        },
        handHighCardValue(cards, highCardSendBack, returnRank){
            if(highCardSendBack > cards.length){
                return -1; // error
            }
            let numbers = new Array(cards.length);
            for(let i = 0; i < numbers.length; i++){
                numbers[i] = cards[i].number;
                if(numbers[i] === 1){
                    numbers[i] = 14;
                }
            }
            numbers.sort(function(a, b){return a - b});
            let result = 0x0;
            if(returnRank){
               result += 0x100000;
            }
            for (let i = 0; i < highCardSendBack; i++) {
                result += numbers[(numbers.length - 1) - i] * this.integerPow(16, (highCardSendBack - 1) - i);
            }
            return result;
        },
        integerPow(base, exponent){
            let result = base;
            for(let i = 1; i < exponent; i++){
                result = result * base;
            }
            if(exponent === 0){
                return 1;
            }
            else{
                return result;
            }
        },
        removeAllMatchingKeys(array, key){
            let newArray = array.filter(function(x){
                return x !== key;
            });
            return newArray;
        },
        removeSomeMatchingKeys(array, key, count){
            for(var i = array.length - 1; i >= 0; i--) {
                if(array[i] === key) {
                    array.splice(i, 1);
                    count--;
                }
                if(count <= 0){
                    i = -1;
                }
            }
        },
        removeDuplicates(numbers){
            let uniqueArray = [];
            for(let i = 0; i < numbers.length; i++){
                if(uniqueArray.indexOf(numbers[i]) === -1){
                    uniqueArray.push(numbers[i]);
                }
            }
            return uniqueArray;
        },
        getTheNumbersArrayA14(cards){
            let numbers = new Array(cards.length);
            for(let i = 0; i < numbers.length; i++){
                numbers[i] = cards[i].number;
                if(numbers[i] === 1){
                    numbers[i] = 14;
                }
            }
            return numbers;
        },
        getTheNumbersArray(cards){
            let numbers = new Array(cards.length);
            for(let i = 0; i < numbers.length; i++){
                numbers[i] = cards[i].number;
            }
            return numbers;
        },
        getTwoToAceCount(numbers){
            let twoToAceCount = new Array(13).fill(0);
            for(let i = 0; i < numbers.length; i++){
                twoToAceCount[numbers[i] - 2]++;
            }
            return twoToAceCount;
        },
        findHighestGroup(twoToAceCount, count){
            let cardNumber = -1;
            for(let i = twoToAceCount.length - 1; i >= 0; i--){
                if(twoToAceCount[i] >= count){
                    cardNumber = i + 2;
                    i = 0;
                }
            }
            return cardNumber;
        },
        getRemainingCards(numbers){
            let remainingCards = new Array(numbers.length);
            for(let i = 0; i < remainingCards.length; i++){
                remainingCards[i] = new Card(numbers[i], 'S');
            }
            return remainingCards;
        },
        convertToChars(base16){
            let s1 = "";
            if(base16[0] === '9'){
                s1 = 'straight flush';
            }
            else if(base16[0] === '8'){
                s1 = 'Quads';
            }
            else if(base16[0] === '7'){
                s1 = 'Full House';
            }
            else if(base16[0] === '6'){
                s1 = 'Flush';
            }
            else if(base16[0] === '5'){
                s1 = 'Straight';
            }
            else if(base16[0] === '4'){
                s1 = 'Three of a Kind';
            }
            else if(base16[0] === '3'){
                s1 = 'Two Pair';
            }
            else if(base16[0] === '2'){
                s1 = 'Pair';
            }
            else {
                s1 = 'High Card';
            }


            for(let i = 1; i < base16.length; i++){
                if (base16[i] === 'e'){
                    s1 += ' A ';
                }
                else if (base16[i] === 'd'){
                    s1 += ' K ';
                }
                else if (base16[i] === 'c'){
                    s1 += ' Q ';
                }
                else if (base16[i] === 'b'){
                    s1 += ' J ';
                }
                else if (base16[i] === 'a'){
                    s1 += ' 10 ';
                }
                else{
                    s1 += ' ' + base16[i] + ' ';
                }
            }
            return s1;
        }
    }
};
</script>
