<!--
the template here is just for testing the functions, it is not going to be included in the final design.
when the server is set up and ready to start assessing hand ranks this code will be modified and added to
the server side such that the server can use it.
-->
<template>
    <div class="box">
        <button v-on:click="toggleImage('1_1')" class="card" id="1_1">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('1_2')" class="card" id="1_2">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('1_3')" class="card" id="1_3">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('1_4')" class="card" id="1_4">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('1_5')" class="card" id="1_5">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('1_6')" class="card" id="1_6">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('1_7')" class="card" id="1_7">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('1_8')" class="card" id="1_8">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('1_9')" class="card" id="1_9">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('1_10')" class="card" id="1_10">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('1_11')" class="card" id="1_11">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('1_12')" class="card" id="1_12">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('1_13')" class="card" id="1_13">
            <img src="../../images/cards.png"/>
        </button>

        <button v-on:click="toggleImage('2_1')" class="card" id="2_1">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('2_2')" class="card" id="2_2">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('2_3')" class="card" id="2_3">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('2_4')" class="card" id="2_4">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('2_5')" class="card" id="2_5">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('2_6')" class="card" id="2_6">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('2_7')" class="card" id="2_7">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('2_8')" class="card" id="2_8">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('2_9')" class="card" id="2_9">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('2_10')" class="card" id="2_10">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('2_11')" class="card" id="2_11">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('2_12')" class="card" id="2_12">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('2_13')" class="card" id="2_13">
            <img src="../../images/cards.png"/>
        </button>
        
        <button v-on:click="toggleImage('3_1')" class="card" id="3_1">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('3_2')" class="card" id="3_2">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('3_3')" class="card" id="3_3">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('3_4')" class="card" id="3_4">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('3_5')" class="card" id="3_5">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('3_6')" class="card" id="3_6">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('3_7')" class="card" id="3_7">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('3_8')" class="card" id="3_8">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('3_9')" class="card" id="3_9">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('3_10')" class="card" id="3_10">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('3_11')" class="card" id="3_11">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('3_12')" class="card" id="3_12">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('3_13')" class="card" id="3_13">
            <img src="../../images/cards.png"/>
        </button>

        <button v-on:click="toggleImage('4_1')" class="card" id="4_1">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('4_2')" class="card" id="4_2">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('4_3')" class="card" id="4_3">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('4_4')" class="card" id="4_4">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('4_5')" class="card" id="4_5">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('4_6')" class="card" id="4_6">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('4_7')" class="card" id="4_7">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('4_8')" class="card" id="4_8">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('4_9')" class="card" id="4_9">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('4_10')" class="card" id="4_10">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('4_11')" class="card" id="4_11">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('4_12')" class="card" id="4_12">
            <img src="../../images/cards.png"/>
        </button>
        <button v-on:click="toggleImage('4_13')" class="card" id="4_13">
            <img src="../../images/cards.png"/>
        </button>

        <button v-on:click="calculate()">get number</button>
        <p id="result">0</p>
        <p id="resultChars">0</p>
    </div>
</template>

<style scoped>

    .card {
        float: left;
        width: 71px;
        height: 96px;
        overflow: hidden;
        opacity: 0.3;
    }

   .card img {
        width: 923px;
        height: 384px;
    }

    .box{
        width: 923px;
        margin: auto;
    }

</style>

<script>
import Card from './Card';

export default {
    name: "HandRankCalculator",
    mounted(){
        // css formating
        for(let i = 1; i <= 4; i++){
            for(let j = 1; j <= 13; j++){
                let a = -1 - (96 * (i-1));
                let b = -9 - (71 * (j-1));
                let div = document.getElementById(i.toString() + '_' + j.toString());
                div.getElementsByTagName('img')[0].style.margin = a.toString() + "px 0px 0px " + b.toString() + "px"; 
            }
        }
    },
    methods:{
        toggleImage(id){
            let cardImage = document.getElementById(id);
            if(cardImage.style.opacity < 1.0){
                cardImage.style.opacity = 1.0;
            }
            else{
                cardImage.style.opacity = 0.3;
            }
        },
        


        // the real code begins here, first it collect the info on the cards and stores that data in an array
        calculate(){
            let cards = new Array(7);
            let k = 0; // k is the number of cards selected in the UI
            for(let i = 1; i <= 4; i++){
                for(let j = 1; j <= 13; j++){
                    let div = document.getElementById(i.toString() + '_' + j.toString());
                    if(div.style.opacity > 0.3){
                        // found a selected card
                        cards[k] = new Card(j, Card.getSuit(i));
                        k++;
                        if(k >= 7){
                            // break the loops
                            i = 5;
                            j = 14;
                        }
                    }
                }
            }
            if(k < 7){
                console.log('not enough cards');
                return;
            }
            // we will iterate through the functions until one returns a positive value
            let allFunctions = [
                this.handStraightFlushValue,
                this.handQuadsValue,
                this.handFullHouseValue,
                this.handFlushValue,
                this.handStraightValue,
                this.handThreeOfAKindValue,
                this.handTwoPairValue,
                this.handSinglePairValue,
                this.handHighCardValue
            ];

            // number refers to how many cards to include in the highcard calculation
            // condition refers to how that function is to return that result, each function
            // uses condition to its own definition
            let setUps = [{},{},{},{condition: false}, {condition: true}, {number: 2}, {number: 1}, {number: 3}, {number: 5, condition: true}];
            
            let result = -1;
            for(let i = 0; i < allFunctions.length; i++){
                result = allFunctions[i](cards, setUps[i]);
                if(result != -1){
                    document.getElementById('result').innerHTML = result.toString(16);
                    document.getElementById('resultChars').innerHTML = this.convertToChars(result.toString(16));
                    return;
                }
            }
        },
        handStraightFlushValue(cards, setup){
            // first assess whether the hand qualifies as a flush, return the numbers that match the flush suit
            let numbers = this.handFlushValue(cards, {condition: true});
            if(numbers === -1){
                return -1;
            }
            let remainingCards = this.getRemainingCards(numbers); // convert the numbers back into card objects
            // now assess whether the remaining cards qualify as a straight
            let straightResult = this.handStraightValue(remainingCards, {condition: false});
            if(straightResult === -1){
                return -1;
            }
            let result = 0x900000 + straightResult; // hexidecimal formating
            return result;
        },
        handQuadsValue(cards, setup){
            let numbers = this.getTheNumbersArrayA14(cards); // we want all aces=14 (1 higher than king=13)
            numbers.sort(function(a, b){return a - b}); // sort the numbers in ascending order
            let twoToAceCount = this.getTwoToAceCount(numbers); // sort the numbers into matching number groups
            let cardNumber = this.findHighestGroup(twoToAceCount, 4);
            if(cardNumber === -1){
                return -1;
            }
            let quadResult = 0;
            for(let k = 4; k > 0; k--){
                quadResult += cardNumber * this.integerPow(16, k); // the hexidecimal result of the quads
            }
            this.removeSomeMatchingKeys(numbers, cardNumber, 4); // need a highcard, remove the quad set and search the remainer
            let remainingCards = this.getRemainingCards(numbers); // convert numbers into card objects
            let highCardResult = this.handHighCardValue(remainingCards, {number: 1, condition: false});
            let result = 0x800000 + quadResult + highCardResult; // combine results into final hexidecimal
            return result;
        },
        handFullHouseValue(cards, setup){
            // first find a three of a kind
            let threeOfAKindValueResult = this.handThreeOfAKindValue(cards, {number:0});
            if(threeOfAKindValueResult === -1){
                return -1;
            }
            let tripletResult = threeOfAKindValueResult.tripletResult;
            let remainingCards = threeOfAKindValueResult.remainingCards; // we will use remaining cards to find a pair
            let singlePairResult = this.handSinglePairValue(remainingCards, {number:0});
            if(singlePairResult === -1){
                return -1;
            }
            let result = 0x700000 + tripletResult * this.integerPow(16, 2) + singlePairResult; // combine results into hexidecimal format
            return result;
        },
        handFlushValue(cards, setup){
            // we sort the cards by suit
            let suits = [];
            suits.push([]); suits.push([]); suits.push([]); suits.push([]);
            for(let i = 0; i < cards.length; i++){
                let number = cards[i].number;
                if(number === 1){
                    number = 14;
                }
                suits[Card.getSuitNumber(cards[i].suit) - 1].push(number);
            }
            let result = 0x600000;
            for(let i = 0; i < 4; i++){
                if(suits[i].length >= 5){ // found a flush
                    suits[i].sort(function(a, b){return a - b});
                    if(setup.condition){ // return the cards, else go further and result calculated result
                        return suits[i];
                    }
                    for(let k = 0; k < 5; k++){
                        result += suits[i][(suits[i].length - 1) - k] * this.integerPow(16, 4-k);
                    }
                    return result;
                }
            }
            return -1;
        },
        handStraightValue(cards, setup){
            // we are trying to find the largest sequence of cards and if 5+ then its a straight
            // first let the ace assume the value of 14 and then include a special condition to check for ace as 1 as well
            let result = -1;
            let numbers = this.getTheNumbersArrayA14(cards);
            numbers.sort(function(a, b){return a - b});
            numbers = this.removeDuplicates(numbers);
            // we start from the end and work our way down and include a special case for the ace also equal to 1
            let count = 1; // we will always have a straight of at least 1
            for(let i = numbers.length - 1; i >= 4; i--){
                // then we go further down, checking each card until either a straight or break is found
                for(let j = i - 1; j >= 0; j--){
                    if(numbers[j] === numbers[i] - count){ // check if sequence still holds
                        count++;
                        if(count === 5){
                            result = 0x000000;
                            // we have a straight
                            if(setup.condition){ // we send back a straight status, or another function called this function and will set their own status
                                result = 0x500000;
                            }
                            for(let k = 0; k < 5; k++){
                                result += numbers[i-k] * this.integerPow(16, 4-k); // add the straight value in hexidecimal
                            }
                            return result;
                        }
                        else if(count === 4 && numbers[i] === 5 && numbers[numbers.length - 1] === 14){
                            // we have count of four going 2,3,4,5 and an ace, its a straight
                            result = 0x000001;
                            if(setup.condition){
                                result = 0x500001;
                            }
                            for(let k = 0; k < 4; k++){
                                result += numbers[i-k] * this.integerPow(16, 4-k);
                            }
                            return result;
                        }
                    }
                    else{
                        // the run ended, set i to position j
                        count = 1;
                        i = j;
                    }
                }
            }
            return result;
        },
        handThreeOfAKindValue(cards, setup){
            let numbers = this.getTheNumbersArrayA14(cards); // get the numbers
            numbers.sort(function(a, b){return a - b}); // sort the numbers
            let twoToAceCount = this.getTwoToAceCount(numbers); // sort numbers into groups
            let cardNumber = this.findHighestGroup(twoToAceCount, 3); // find the highest group
            if(cardNumber === -1){
                return -1;
            }
            let tripletResult = 0;
            for(let k = 2; k >= 0; k--){
                tripletResult += cardNumber * this.integerPow(16, setup.number + k); // add the hexidecimal value
            }
            this.removeSomeMatchingKeys(numbers, cardNumber, 3);
            let remainingCards = this.getRemainingCards(numbers);
            
            if(setup.number === 0){ // another function called this and only wants the cards
                return {tripletResult: tripletResult, remainingCards: remainingCards};
            }
            // if we made it to this point then send back the full "3 of a kind" status
            let highCardsResult = this.handHighCardValue(remainingCards, {number: setup.number, condition: false});
            if(highCardsResult === -1){
                return -1; // error
            }
            let result = 0x400000 + tripletResult + highCardsResult;
            return result;
        },
        handTwoPairValue(cards, setup){
            let numbers = this.getTheNumbersArrayA14(cards); // get the numbers
            numbers.sort(function(a, b){return a - b}); // sort the numbers
            let twoToAceCount = this.getTwoToAceCount(numbers); // sort the numbers into groups
            let cardNumber = this.findHighestGroup(twoToAceCount, 2); // find first pair
            if(cardNumber === -1){
                return -1;
            }
            let firstPairResult = cardNumber * this.integerPow(16, setup.number + 3) + cardNumber * this.integerPow(16, setup.number + 2);
            this.removeSomeMatchingKeys(numbers, cardNumber, 2);
            let remainingCards = this.getRemainingCards(numbers);
            let secondPairResult = this.handSinglePairValue(remainingCards, setup); // find second pair of remaining cards
            if(secondPairResult === -1){
                return -1;
            }
            let result = 0x300000 + firstPairResult + (secondPairResult - 0x200000); // remove the single pair status
            return result;
        },
        handSinglePairValue(cards, setup){ // find the highest pair
            let numbers = this.getTheNumbersArrayA14(cards);
            numbers.sort(function(a, b){return a - b}); // now the array is sort low to high
            let twoToAceCount = this.getTwoToAceCount(numbers);
            let cardNumber = this.findHighestGroup(twoToAceCount, 2);
            if(cardNumber === -1){
                return -1;
            }
            let pairResult = cardNumber * this.integerPow(16, setup.number + 1) + cardNumber * this.integerPow(16, setup.number);
            if(setup.number === 0){
                return pairResult;
            }
            this.removeSomeMatchingKeys(numbers, cardNumber, 2);
            let remainingCards = this.getRemainingCards(numbers);
            let highCardResult = this.handHighCardValue(remainingCards, {number: setup.number, condition: false}); // if full house is calling this then highCardSendBack = 0, and 0 is returned
            let result = 0x200000 + pairResult + highCardResult;
            return result;
        },
        handHighCardValue(cards, setup){ // find the highcards
            if(setup.number > cards.length){
                return -1; // error
            }
            let numbers = new Array(cards.length);
            for(let i = 0; i < numbers.length; i++){
                numbers[i] = cards[i].number;
                if(numbers[i] === 1){
                    numbers[i] = 14;
                }
            }
            numbers.sort(function(a, b){return a - b});
            let result = 0x0;
            if(setup.condition){
               result += 0x100000;
            }
            for (let i = 0; i < setup.number; i++) {
                result += numbers[(numbers.length - 1) - i] * this.integerPow(16, (setup.number - 1) - i);
            }
            return result;
        },
        integerPow(base, exponent){
            let result = base;
            for(let i = 1; i < exponent; i++){
                result = result * base;
            }
            if(exponent === 0){
                return 1;
            }
            else{
                return result;
            }
        },
        removeAllMatchingKeys(array, key){
            let newArray = array.filter(function(x){
                return x !== key;
            });
            return newArray;
        },
        removeSomeMatchingKeys(array, key, count){
            for(var i = array.length - 1; i >= 0; i--) {
                if(array[i] === key) {
                    array.splice(i, 1);
                    count--;
                }
                if(count <= 0){
                    i = -1;
                }
            }
        },
        removeDuplicates(numbers){
            let uniqueArray = [];
            for(let i = 0; i < numbers.length; i++){
                if(uniqueArray.indexOf(numbers[i]) === -1){
                    uniqueArray.push(numbers[i]);
                }
            }
            return uniqueArray;
        },
        getTheNumbersArrayA14(cards){
            let numbers = new Array(cards.length);
            for(let i = 0; i < numbers.length; i++){
                numbers[i] = cards[i].number;
                if(numbers[i] === 1){
                    numbers[i] = 14;
                }
            }
            return numbers;
        },
        getTheNumbersArray(cards){
            let numbers = new Array(cards.length);
            for(let i = 0; i < numbers.length; i++){
                numbers[i] = cards[i].number;
            }
            return numbers;
        },
        getTwoToAceCount(numbers){
            let twoToAceCount = new Array(13).fill(0);
            for(let i = 0; i < numbers.length; i++){
                twoToAceCount[numbers[i] - 2]++;
            }
            return twoToAceCount;
        },
        findHighestGroup(twoToAceCount, count){
            let cardNumber = -1;
            for(let i = twoToAceCount.length - 1; i >= 0; i--){
                if(twoToAceCount[i] >= count){
                    cardNumber = i + 2;
                    i = 0;
                }
            }
            return cardNumber;
        },
        getRemainingCards(numbers){
            let remainingCards = new Array(numbers.length);
            for(let i = 0; i < remainingCards.length; i++){
                remainingCards[i] = new Card(numbers[i], 'S');
            }
            return remainingCards;
        },
        convertToChars(base16){
            let s1 = "";
            if(base16[0] === '9'){
                s1 = 'straight flush';
            }
            else if(base16[0] === '8'){
                s1 = 'Quads';
            }
            else if(base16[0] === '7'){
                s1 = 'Full House';
            }
            else if(base16[0] === '6'){
                s1 = 'Flush';
            }
            else if(base16[0] === '5'){
                s1 = 'Straight';
            }
            else if(base16[0] === '4'){
                s1 = 'Three of a Kind';
            }
            else if(base16[0] === '3'){
                s1 = 'Two Pair';
            }
            else if(base16[0] === '2'){
                s1 = 'Pair';
            }
            else {
                s1 = 'High Card';
            }


            for(let i = 1; i < base16.length; i++){
                if (base16[i] === 'e'){
                    s1 += ' A ';
                }
                else if (base16[i] === 'd'){
                    s1 += ' K ';
                }
                else if (base16[i] === 'c'){
                    s1 += ' Q ';
                }
                else if (base16[i] === 'b'){
                    s1 += ' J ';
                }
                else if (base16[i] === 'a'){
                    s1 += ' 10 ';
                }
                else{
                    s1 += ' ' + base16[i] + ' ';
                }
            }
            return s1;
        }
    }
};
</script>
